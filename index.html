<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Квиз: расчет кухни</title>
  <!-- VK Bridge (optional inside VK Mini App) -->
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  <script>
    (function(){
      try {
        vkBridge.send('VKWebAppInit');
        
        // Добавляем класс для VK Mini App
        document.body.classList.add('vk-mini-app');
        
        // На десктопе запрашиваем 800x800 несколько раз, чтобы обойти раннюю инициализацию
        const ensureResize800 = async () => {
          try{
            const params = await vkBridge.send('VKWebAppGetLaunchParams');
            const platform = (params && params.vk_platform) || '';
            const isDesktop = !/mobile|iphone|ipad|android/i.test(platform);
            if(!isDesktop) return;
            
            const tryResize = async () => {
              try{ await vkBridge.send('VKWebAppResizeWindow', { width: 800, height: 800 }); }catch(e){}
            };
            await tryResize();
            setTimeout(tryResize, 200);
            setTimeout(tryResize, 600);
          }catch(err){
            console.warn('ResizeWindow не поддерживается в этом окружении', err);
          }
        };
        ensureResize800();
      } catch(e) {
        console.warn('VK Bridge не доступен в этом окружении');
      }
    })();
  </script>
  <style>
    :root{
      --green:#3db627;
      --green-weak: rgba(61,182,39,.2);
      --text:#111;
      --muted:#666;
      --bg:#fff;
      --card:#fff;
      --accent:#2e8f1d;
      --border:#e8e8e8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,Helvetica Neue,Noto Sans,sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.4;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px;min-width:320px}
    .promo{
      display:flex;gap:12px;align-items:center;
      padding:12px 16px;border-radius:10px;background:#fff;border:1px solid var(--border);
      box-shadow:0 1px 4px rgba(0,0,0,.03);
      font-size:15px;color:#0d2; /* green icon mimic */
    }
    .promo span{color:#111}
    .bar{
      margin:14px 0 24px;border-radius:4px;height:6px;background:var(--green-weak);overflow:hidden;
    }
    .bar>i{display:block;height:100%;width:0;background:var(--green);transition:width .25s ease}
    .card{display:block}
    .title{font-weight:700;font-size:28px;margin:0 0 8px}
    .subtitle{color:var(--muted)}
    .choices{display:grid;grid-template-columns:repeat(3, minmax(180px, 1fr));gap:22px;min-width:0}
    .choice{
      border:2px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card);
      cursor:pointer;transition:transform .1s ease, box-shadow .15s ease, border-color .15s ease;
      display:flex;flex-direction:column;
    }
    .choice:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .choice input{display:none}
    .choice .img{position:relative;aspect-ratio:1/1;background:#f4f4f4;display:block;background-size:cover;background-position:center;width:100%;height:auto}
    .choice .name{padding:10px 12px;font-size:15px;word-wrap:break-word;overflow-wrap:break-word;hyphens:auto;text-align:left;display:block}
    .choice.selected{border-color:var(--green); border-width:2px; box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .choice.selected .img:after{
      content:"";position:absolute;inset:auto 8px 8px auto;width:26px;height:26px;border-radius:50%;
      background:var(--green);box-shadow:0 2px 8px rgba(0,0,0,.2);
      mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23fff" d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>') center/18px no-repeat;
      -webkit-mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23fff" d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>') center/18px no-repeat;
      color:#fff;
    }
    .radios{display:grid;gap:12px}
    .radio{
      display:flex;align-items:center;gap:10px;padding:14px;border-radius:12px;background:#f6f6f6;border:1px solid #eee;cursor:pointer
    }
    .radio input{display:none}
    .radio .dot{
      width:18px;height:18px;border-radius:50%;border:2px solid var(--green);display:inline-block;position:relative;background:#fff;
    }
    .radio.selected{background:#f3f7f3;border-color:#e2f4e2}
    .radio.selected .dot{background:var(--green)}
    .nav{
      display:flex;gap:12px;justify-content:flex-end;margin-top:24px
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:10px;border:1.5px solid var(--green);
      background:#fff;color:var(--green);cursor:pointer;font-weight:600
    }
    .btn.primary{background:var(--green);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .contact-methods{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .pill.selected{border-color:var(--green);background:var(--green-weak)}
    .inputs{display:grid;gap:12px}
    input[type="tel"], input[type="text"]{
      width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--border);font-size:16px
    }
    .left-illu{display:flex;align-items:flex-start;justify-content:center}
    .left-illu .illu{
      width:180px;height:180px;background:#f5faf5;border:1px dashed var(--green);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:42px;color:var(--green)
    }
    @media (max-width:960px){
      .choices{grid-template-columns:repeat(2, minmax(160px,1fr))}
    }

    /* Только для 2-го вопроса (layout) на планшетах/небольших экранах делаем 3 колонки. */
    @media (min-width:720px) and (max-width:960px){
      #step[data-step="layout"] .choices{grid-template-columns:repeat(3, minmax(160px,1fr))}
    }
    
    /* Стили для VK Mini App на мобильных устройствах (только для экранов меньше 800px) */
    @media (max-width: 799px) {
      .vk-mini-app .choices {
        grid-template-columns: repeat(2, minmax(120px, 1fr));
        gap: 12px;
      }
      .vk-mini-app .choice .img {
        aspect-ratio: 1/1;
        width: 100%;
        height: auto;
      }
      .vk-mini-app .choice .name {
        padding: 8px 6px;
        font-size: 13px;
        line-height: 1.2;
        min-height: 2.4em;
        text-align: left;
        display:block;
      }
      .vk-mini-app .title {
        font-size: 22px;
        margin: 0 0 4px;
      }
      .vk-mini-app .wrap {
        padding: 16px;
      }
      .vk-mini-app .promo {
        padding: 8px 12px;
        font-size: 13px;
      }
      .vk-mini-app .bar {
        margin: 10px 0 16px;
      }
    }
    
    /* Стили для очень маленьких экранов (320px и больше) */
    @media (min-width: 320px) and (max-width: 479px) {
      .wrap {
        padding: 12px;
        max-width: 100%;
      }
      
      .promo {
        padding: 8px 10px;
        font-size: 12px;
        gap: 8px;
      }
      
      .title {
        font-size: 20px;
        margin: 0 0 6px;
      }
      
      .subtitle {
        font-size: 14px;
      }
      
      .choices {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .choice {
        min-width: 0;
      }
      
      .choice .img {
        aspect-ratio: 1/1;
        width: 100%;
        height: auto;
      }
      
      .choice .name {
        padding: 8px 6px;
        font-size: 13px;
        line-height: 1.2;
        min-height: 2.4em;
        text-align: left;
        display:block;
      }
      
      .radios {
        gap: 8px;
      }
      
      .radio {
        padding: 10px 12px;
        font-size: 14px;
      }
      
      .radio .dot {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }
      
      .contact-methods {
        gap: 6px;
      }
      
      .pill {
        padding: 6px 10px;
        font-size: 13px;
      }
      
      input[type="tel"], input[type="text"] {
        padding: 12px 10px;
        font-size: 16px; /* Предотвращает зум на iOS */
      }
      
      .nav {
        gap: 8px;
        margin-top: 16px;
      }
      
      .btn {
        padding: 10px 14px;
        font-size: 14px;
        gap: 6px;
      }
      
      .bar {
        margin: 8px 0 12px;
        height: 4px;
      }
      
      /* Специальные стили для экрана благодарности */
      #step[data-step="thank-you"] {
        padding: 20px 10px;
      }
      
      #step[data-step="thank-you"] .title {
        font-size: 24px;
        margin-bottom: 12px;
      }
      
      #step[data-step="thank-you"] .subtitle {
        font-size: 16px;
        line-height: 1.4;
      }
    }
    
    /* Стили для средних экранов (480px - 799px) */
    @media (min-width: 480px) and (max-width: 799px) {
      .wrap {
        padding: 16px;
      }
      
      .promo {
        padding: 10px 12px;
        font-size: 14px;
      }
      
      .title {
        font-size: 24px;
        margin: 0 0 6px;
      }
      
      .choices {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .choice .img {
        aspect-ratio: 1/1;
        width: 100%;
        height: auto;
      }
      
      .choice .name {
        padding: 10px 8px;
        font-size: 14px;
        line-height: 1.3;
        min-height: 2.6em;
        text-align: left;
        display:block;
      }
      
      .radio {
        padding: 12px 14px;
        font-size: 15px;
      }
      
      .pill {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      input[type="tel"], input[type="text"] {
        padding: 14px 12px;
        font-size: 16px;
      }
      
      .btn {
        padding: 12px 16px;
        font-size: 15px;
      }
    }
    
    /* Стили для десктопной версии в модальном окне */
    @media (min-width: 800px) {
      .choices {
        grid-template-columns: repeat(4, minmax(140px, 1fr));
        gap: 16px;
        justify-items: center;
      }
      .choice {
        width: 140px;
        max-width: 140px;
      }
      .choice .img {
        aspect-ratio: 1/1;
        width: 100%;
        height: auto;
      }
      .choice .name {
        padding: 10px 8px;
        font-size: 14px;
        line-height: 1.3;
        min-height: 2.6em;
        text-align: left;
        display:block;
      }
      .title {
        font-size: 24px;
        margin: 0 0 6px;
      }
      .wrap {
        padding: 20px;
      }
      .promo {
        padding: 10px 14px;
        font-size: 14px;
      }
      .bar {
        margin: 12px 0 20px;
      }
      
      /* Специальные стили для вопросов 1 (style), 2 (layout) и 6 (gift) - максимально большие изображения без скролла */
      #step[data-step="style"] .choices {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        justify-items: stretch;
      }
      #step[data-step="layout"] .choices {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        justify-items: stretch;
      }
      #step[data-step="gift"] .choices {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        justify-items: stretch;
      }
      #step[data-step="style"] .choice {
        width: 100%;
        height: 260px;
        max-width: none;
        max-height: 260px;
        display: flex;
        flex-direction: column;
      }
      #step[data-step="layout"] .choice {
        width: 100%;
        height: 220px;
        max-width: none;
        max-height: 220px;
        display: flex;
        flex-direction: column;
      }
      #step[data-step="gift"] .choice {
        width: 100%;
        height: 260px;
        max-width: none;
        max-height: 260px;
        display: flex;
        flex-direction: column;
      }
      #step[data-step="style"] .choice .img {
        height: 200px;
        width: 100%;
        max-height: 200px;
        max-width: 100%;
        flex-shrink: 0;
      }
      #step[data-step="layout"] .choice .img {
        height: 170px;
        width: 100%;
        max-height: 170px;
        max-width: 100%;
        flex-shrink: 0;
      }
      #step[data-step="gift"] .choice .img {
        height: 200px;
        width: 100%;
        max-height: 200px;
        max-width: 100%;
        flex-shrink: 0;
      }
      #step[data-step="style"] .choice .name,
      #step[data-step="layout"] .choice .name,
      #step[data-step="gift"] .choice .name {
        padding: 8px 10px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="promo">🟢 <span>Узнайте стоимость вашей кухни за 2 минуты и получите подарок!</span></div>
    <div class="bar" aria-label="Прогресс"><i id="progress"></i></div>

    <!-- Шаги -->
    <section id="step" class="card"></section>

    <div class="nav">
      <button class="btn" id="back"><span>←</span> Назад</button>
      <button class="btn primary" id="next">Далее <span>→</span></button>
    </div>
  </div>

<script>
// === ДАННЫЕ ШАГОВ (вынесены, чтобы можно было легко редактировать) ===
const STEPS = [
  {
    key: 'style',
    title: 'Выберите предпочтительный стиль',
    type: 'tiles',
    tiles: [
      { label: 'Фасады с декором', img: 'https://optim.tildacdn.com/tild3331-3438-4961-a236-363832636336/-/cover/360x360/center/center/-/format/webp/decor_2.png.webp' },
      { label: 'Гладкие фасады без ручек', img: 'https://optim.tildacdn.com/tild3666-6465-4631-b134-366231313766/-/cover/360x360/center/center/-/format/webp/20250729_1852_Minima.png.webp' },
      { label: 'Кухня в потолок с антресолью', img: 'https://optim.tildacdn.com/tild3437-6632-4439-b839-626133613536/-/cover/360x360/center/center/-/format/webp/mezz.png.webp' },
      { label: 'Ещё не определились', img: 'https://optim.tildacdn.com/tild6539-6630-4337-a238-336530343334/-/cover/360x360/center/center/-/format/webp/dnk.png.webp' },
    ]
  },
  {
    key: 'layout',
    title: 'Выберете планировку вашей будущей кухни',
    type: 'tiles',
    tiles: [
      { label: 'Прямая', img: 'https://optim.tildacdn.com/tild6430-3231-4166-b935-663039366362/-/resize/360x360/-/format/webp/str.png.webp' },
      { label: 'П-образная', img: 'https://optim.tildacdn.com/tild3530-3032-4332-a132-366462613937/-/resize/360x360/-/format/webp/a61c8d2d-280d-4280-a.png.webp' },
      { label: 'Угловая', img: 'https://optim.tildacdn.com/tild6132-6534-4237-b161-316665333161/-/resize/360x360/-/format/webp/L.jpg.webp' },
      { label: 'С островом', img: 'https://optim.tildacdn.com/tild3262-3932-4633-b036-373532653064/-/resize/360x360/-/format/webp/5d06167a-5c45-45c4-b.png.webp' },
      { label: 'Другая', img: 'https://optim.tildacdn.com/tild3432-6539-4564-a633-326531626333/-/resize/360x360/-/format/webp/fd8b5dea-697a-4697-b.jpg.webp' },
      { label: 'Ещё не знаю', img: 'https://optim.tildacdn.com/tild3466-3833-4434-b864-343836656631/-/resize/360x360/-/format/webp/dnk2.png.webp' },
    ]
  },
  {
    key: 'area',
    title: 'Укажите площадь вашей кухни в метрах²',
    type: 'radios',
    radios: ['Менее 10 метров²','10 - 15 метров²','16 - 20 метров²','Более 20 метров²','Точно не помню'],
    illu: 'm²'
  },
  {
    key: 'deadline',
    title: 'В какие сроки вам нужна кухня?',
    type: 'radios',
    radios: ['От 1 до 2 месяцев','От 2 до 4 месяцев','От 4 месяцев','Затрудняюсь точно ответить'],
    illu: '⏱️'
  },
  {
    key: 'budget',
    title: 'В какой бюджет вы планируете уложиться?',
    type: 'radios',
    radios: ['130 - 200 тысяч рублей','200 - 300 тысяч рублей','300 - 400 тысяч рублей','Более 400 тысяч рублей'],
    illu: '₽'
  },
  {
    key: 'gift',
    title: 'Выберете подарок к вашей кухне',
    type: 'tiles',
    tiles: [
      { label: 'Вытяжка', img: 'https://static.tildacdn.com/tild3836-3566-4139-b664-316664376436/photo.png' },
      { label: 'Подсветка', img: 'https://static.tildacdn.com/tild3330-3932-4430-a232-383734306163/3.png' },
      { label: 'Мойка', img: 'https://static.tildacdn.com/tild6237-6535-4864-b937-633166306132/2.png' },
    ]
  },
  {
    key: 'contact',
    title: 'Готово!',
    subtitle: 'Выберете, как бы вы хотели получить расчёт стоимости кухни по вашим параметрам',
    type: 'contact'
  }
];

const state = { step:0, answers:{} };

const elStep = document.getElementById('step');
const elBack = document.getElementById('back');
const elNext = document.getElementById('next');
const elProgress = document.getElementById('progress');

elBack.addEventListener('click', () => { if(state.step>0){ state.step--; render(); }});
elNext.addEventListener('click', () => { 
  const validation = validate();
  if(!validation.valid) { 
    alert('Пожалуйста, исправьте следующие ошибки:\n\n' + validation.errors.join('\n'));
    return; 
  }
  if(state.step < STEPS.length - 1){ state.step++; render(); }
  else { submit(); }
});

function setProgress(){
  const p = Math.round(((state.step+1)/STEPS.length)*100);
  elProgress.style.width = p + '%';
}

function makeChoiceTile(item, groupKey, selectedValue){
  const div = document.createElement('label');
  div.className = 'choice' + (selectedValue===item.label ? ' selected' : '');
  div.innerHTML = '<input type="radio" name="'+groupKey+'"/>' +
                  '<span class="img" style="background-image:url('+CSS.escape(item.img)+')"></span>' +
                  '<div class="name">'+item.label+'</div>';
  div.addEventListener('click', () => { state.answers[groupKey] = item.label; render(); });
  return div;
}

function makeRadio(label, groupKey, selectedValue){
  const div = document.createElement('label');
  div.className = 'radio' + (selectedValue===label ? ' selected' : '');
  div.innerHTML = '<input type="radio" name="'+groupKey+'"/><i class="dot"></i><span>'+label+'</span>';
  div.addEventListener('click', ()=>{ state.answers[groupKey] = label; render(); });
  return div;
}

function render(){
  setProgress();
  const s = STEPS[state.step];
  elBack.disabled = state.step===0;
  elNext.textContent = state.step === STEPS.length - 1 ? 'Отправить' : 'Далее →';

  // Create main container
  const container = document.createElement('div');
  
  // Add title at the top
  const titleSection = document.createElement('div');
  titleSection.innerHTML = '<h1 class="title">'+s.title+'</h1>' + (s.subtitle ? '<div class="subtitle">'+s.subtitle+'</div>' : '');
  container.appendChild(titleSection);

  // Add content below title
  const contentSection = document.createElement('div');
  contentSection.style.marginTop = '24px';
  
  if(s.type==='tiles'){
    const grid = document.createElement('div'); grid.className='choices';
    (s.tiles||[]).forEach(t => grid.appendChild(makeChoiceTile(t, s.key, state.answers[s.key])));
    contentSection.appendChild(grid);
  }else if(s.type==='radios'){
    const list = document.createElement('div'); list.className='radios';
    s.radios.forEach(r => list.appendChild(makeRadio(r, s.key, state.answers[s.key])));
    contentSection.appendChild(list);
  }else if(s.type==='contact'){
    const methods = document.createElement('div'); methods.className='contact-methods';
    methods.style.marginBottom = '20px';
    
    // Добавляем заголовок для методов связи
    const methodsTitle = document.createElement('div');
    methodsTitle.textContent = 'Выберите способ связи *';
    methodsTitle.style.fontSize = '16px';
    methodsTitle.style.fontWeight = '600';
    methodsTitle.style.marginBottom = '12px';
    methodsTitle.style.color = 'var(--text)';
    methods.appendChild(methodsTitle);
    
    const methodsContainer = document.createElement('div');
    methodsContainer.style.display = 'flex';
    methodsContainer.style.gap = '8px';
    methodsContainer.style.flexWrap = 'wrap';
    
    ['Телефон','Telegram','WhatsApp'].forEach(m=>{
      const pill=document.createElement('button'); 
      pill.type='button'; 
      pill.className='pill'+(state.answers['method']===m?' selected':''); 
      pill.textContent=m;
      pill.addEventListener('click',()=>{ state.answers.method=m; render(); });
      methodsContainer.appendChild(pill);
    });
    methods.appendChild(methodsContainer);
    
    const inputs = document.createElement('div'); 
    inputs.className='inputs';
    inputs.style.display = 'grid';
    inputs.style.gap = '16px';
    
    // Поле для телефона
    const phoneContainer = document.createElement('div');
    const phoneLabel = document.createElement('div');
    phoneLabel.textContent = 'Номер телефона *';
    phoneLabel.style.fontSize = '16px';
    phoneLabel.style.fontWeight = '600';
    phoneLabel.style.marginBottom = '8px';
    phoneLabel.style.color = 'var(--text)';
    
    const phone = document.createElement('input'); 
    phone.type='tel'; 
    phone.placeholder='+7 (999) 999-99-99'; 
    phone.value = state.answers.phone || '';
    phone.style.width = '100%';
    phone.style.padding = '14px 12px';
    phone.style.borderRadius = '12px';
    phone.style.border = '1px solid var(--border)';
    phone.style.fontSize = '16px';
    phone.style.boxSizing = 'border-box';
    
    // Добавляем валидацию телефона
    phone.addEventListener('input', function(e) {
      let value = e.target.value;
      
      // Удаляем все символы кроме цифр, +, (, ), -, пробелов
      value = value.replace(/[^\d\s\(\)\+\-]/g, '');
      
      // Ограничиваем длину
      if (value.length > 25) {
        value = value.substring(0, 25);
      }
      
      e.target.value = value;
      state.answers.phone = value;
      
      // Проверяем валидность с использованием normalizePhone
      validatePhoneField(phone);
    });
    
    phone.addEventListener('blur', function() {
      validatePhoneField(phone);
    });
    
    phoneContainer.appendChild(phoneLabel);
    phoneContainer.appendChild(phone);
    
    // Поле для имени
    const nameContainer = document.createElement('div');
    const nameLabel = document.createElement('div');
    nameLabel.textContent = 'Ваше имя *';
    nameLabel.style.fontSize = '16px';
    nameLabel.style.fontWeight = '600';
    nameLabel.style.marginBottom = '8px';
    nameLabel.style.color = 'var(--text)';
    
    const name = document.createElement('input'); 
    name.type='text'; 
    name.placeholder='Введите ваше имя'; 
    name.value = state.answers.name || '';
    name.style.width = '100%';
    name.style.padding = '14px 12px';
    name.style.borderRadius = '12px';
    name.style.border = '1px solid var(--border)';
    name.style.fontSize = '16px';
    name.style.boxSizing = 'border-box';
    
    name.addEventListener('input', e=> state.answers.name = e.target.value);
    
    nameContainer.appendChild(nameLabel);
    nameContainer.appendChild(name);
    
    contentSection.appendChild(methods);
    contentSection.appendChild(phoneContainer);
    contentSection.appendChild(nameContainer);
  }

  container.appendChild(contentSection);

  // Помечаем текущий шаг атрибутом для точечного применения стилей
  elStep.setAttribute('data-step', s.key);
  elStep.replaceChildren(container);
  if(s.type==='tiles'){
    fitTileLabelsToOneLine(elStep);
  }
}

// Подгоняет размер шрифта подписей в плитках так, чтобы все помещались в одну строку
function fitTileLabelsToOneLine(scope){
  const nameNodes = Array.from(scope.querySelectorAll('.choice .name'));
  if(nameNodes.length===0) return;
  
  // Проверяем ширину экрана
  const isSmallScreen = window.innerWidth <= 479;
  
  // сбрасываем возможные предыдущие инлайновые размеры
  nameNodes.forEach(n => { 
    n.style.fontSize=''; 
    // На маленьких экранах разрешаем перенос строк
    n.style.whiteSpace = isSmallScreen ? 'normal' : 'nowrap';
    n.style.wordWrap = isSmallScreen ? 'break-word' : 'normal';
    n.style.overflowWrap = isSmallScreen ? 'break-word' : 'normal';
  });
  
  // На маленьких экранах не изменяем размер шрифта, позволяем тексту переноситься
  if(isSmallScreen) return;
  
  const computed = parseFloat(getComputedStyle(nameNodes[0]).fontSize) || 14;
  const minPx = 12;
  const maxPx = Math.max(18, computed); // позволяем увеличить до 18px минимум

  const overflows = () => nameNodes.some(el => el.scrollWidth > el.clientWidth);

  // бинарный поиск максимального размера, который влезает у всех одновременно
  let lo = minPx, hi = maxPx, best = minPx;
  while(lo <= hi){
    const mid = Math.floor((lo + hi) / 2);
    nameNodes.forEach(n => n.style.fontSize = mid + 'px');
    if(!overflows()){
      best = mid;
      lo = mid + 1;
    }else{
      hi = mid - 1;
    }
  }
  nameNodes.forEach(n => n.style.fontSize = best + 'px');
}

// Убрали наблюдателей размеров, используем только CSS для единообразия размеров

function validate(){
  const s = STEPS[state.step];
  if(s.type==='tiles' || s.type==='radios'){
    if (!state.answers[s.key]) {
      return { valid: false, errors: ['Пожалуйста, выберите вариант'] };
    }
    return { valid: true };
  }
  if(s.type==='contact'){
    const errors = [];
    
    // Проверяем, что выбран способ связи
    if (!state.answers.method) {
      errors.push('• Выберите способ связи');
    }
    
    // Проверяем, что введено имя
    if (!state.answers.name || state.answers.name.trim().length < 2) {
      errors.push('• Введите ваше имя (минимум 2 символа)');
    }
    
    // Проверяем валидность телефона с использованием normalizePhone
    const phoneValue = state.answers.phone || '';
    const phoneResult = normalizePhone(phoneValue);
    
    if (!phoneValue.trim()) {
      errors.push('• Введите номер телефона');
    } else if (!phoneResult.valid) {
      // Показываем понятные сообщения об ошибках
      switch (phoneResult.reason) {
        case 'empty':
          errors.push('• Введите номер телефона');
          break;
        case 'all_same_digits':
          errors.push('• Номер телефона не может состоять из одинаковых цифр');
          break;
        case 'all_zeros':
          errors.push('• Номер телефона не может состоять только из нулей');
          break;
        case 'length':
          errors.push('• Номер телефона должен содержать от 10 до 15 цифр');
          break;
        case 'leading_zero':
          errors.push('• Номер телефона не может начинаться с нуля');
          break;
        case 'e164':
          errors.push('• Введите корректный номер телефона в международном формате');
          break;
        default:
          errors.push('• Введите корректный номер телефона');
      }
    }
    
    // Возвращаем результат валидации
    if (errors.length > 0) {
      return { valid: false, errors: errors };
    }
    
    return { valid: true };
  }
  return { valid: true };
}

// Универсальная нормализация телефона в E.164 (+XXXXXXXXXX...)
// Возвращает { valid, e164, reason }
function normalizePhone(raw) {
  if (!raw) return { valid: false, e164: "", reason: "empty" };

  // 1) убрать всё, кроме цифр и '+' (только первый '+')
  let v = String(raw).trim();
  const plus = v.startsWith("+");
  v = (plus ? "+" : "") + v.replace(/[^\d]/g, "");

  // 2) если начинается с '00', преобразуем в '+'
  if (v.startsWith("00")) v = "+" + v.slice(2);

  // 3) Russian special-case: 8XXXXXXXXXX (11 цифр) → +7XXXXXXXXXX
  let digits = v.replace(/\D/g, "");
  if (!plus && digits.length === 11 && digits[0] === "8") {
    digits = "7" + digits.slice(1);
    v = "+" + digits;
  }

  // 4) Базовая E.164: +, затем 10–15 цифр, первая цифра от 1 до 9
  // Пропустим и вариант без '+' (например, "7999..."), превратим в '+...'
  if (!v.startsWith("+")) v = "+" + digits;
  digits = v.replace(/\D/g, "");

  // дисквалифицируем заведомо мусор: все цифры одинаковые / все нули
  const allSame = /^(\d)\1+$/.test(digits);
  if (allSame) return { valid: false, e164: "", reason: "all_same_digits" };
  if (/^0+$/.test(digits)) return { valid: false, e164: "", reason: "all_zeros" };

  // длина и первая цифра
  if (digits.length < 10 || digits.length > 15) {
    return { valid: false, e164: "", reason: "length" };
  }
  if (digits[0] === "0") {
    return { valid: false, e164: "", reason: "leading_zero" };
  }

  // финальная проверка шаблона E.164
  const e164 = "+" + digits;
  if (!/^\+[1-9]\d{9,14}$/.test(e164)) {
    return { valid: false, e164: "", reason: "e164" };
  }
  return { valid: true, e164 };
}

// Функция валидации поля телефона с использованием normalizePhone
function validatePhoneField(phoneInput) {
  const value = phoneInput.value;
  const result = normalizePhone(value);
  
  // Визуальная индикация валидности
  if (value && !result.valid) {
    phoneInput.style.borderColor = '#ff4444';
    phoneInput.style.backgroundColor = '#fff5f5';
  } else if (value && result.valid) {
    phoneInput.style.borderColor = 'var(--green)';
    phoneInput.style.backgroundColor = '#f8fff8';
  } else {
    phoneInput.style.borderColor = 'var(--border)';
    phoneInput.style.backgroundColor = '#fff';
  }
  
  return result.valid;
}

function submit(){
  // Показать итог/отправить куда нужно. Здесь — просто alert + лог.
  const payload = JSON.stringify(state.answers, null, 2);
  console.log('Ответы квиза:', state.answers);
  
  // Скрываем навигацию
  document.querySelector('.nav').style.display = 'none';
  
  // Показываем экран благодарности
  showThankYouScreen();
  
  // Пример отправки на сервер/бота:
  // fetch('/lead', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(state.answers) })
  //   .then(()=>showThankYouScreen()).catch(()=>alert('Ошибка отправки'));
}

function showThankYouScreen(){
  const container = document.createElement('div');
  container.style.textAlign = 'center';
  container.style.padding = '40px 20px';
  
  // Иконка галочки
  const checkIcon = document.createElement('div');
  checkIcon.style.width = '80px';
  checkIcon.style.height = '80px';
  checkIcon.style.borderRadius = '50%';
  checkIcon.style.background = 'var(--green)';
  checkIcon.style.margin = '0 auto 24px';
  checkIcon.style.display = 'flex';
  checkIcon.style.alignItems = 'center';
  checkIcon.style.justifyContent = 'center';
  checkIcon.style.fontSize = '40px';
  checkIcon.style.color = '#fff';
  checkIcon.innerHTML = '✓';
  
  // Заголовок
  const title = document.createElement('h1');
  title.className = 'title';
  title.textContent = 'Спасибо!';
  title.style.marginBottom = '16px';
  
  // Подзаголовок
  const subtitle = document.createElement('div');
  subtitle.className = 'subtitle';
  subtitle.textContent = 'Мы получили вашу заявку и скоро свяжемся с вами.';
  subtitle.style.fontSize = '18px';
  subtitle.style.lineHeight = '1.5';
  subtitle.style.color = 'var(--muted)';
  subtitle.style.marginBottom = '32px';
  
  // Кнопка возврата
  const returnButton = document.createElement('button');
  returnButton.className = 'btn primary';
  returnButton.textContent = 'Вернуться в сообщество';
  returnButton.style.marginTop = '24px';
  returnButton.addEventListener('click', handleReturn);
  
  container.appendChild(checkIcon);
  container.appendChild(title);
  container.appendChild(subtitle);
  container.appendChild(returnButton);
  
  // Помечаем как экран благодарности
  elStep.setAttribute('data-step', 'thank-you');
  elStep.replaceChildren(container);
  
  // Обновляем прогресс-бар на 100%
  elProgress.style.width = '100%';
}

// Функция обработки возврата с комбинированным подходом
async function handleReturn() {
  try {
    // Проверяем, доступен ли VK Bridge
    if (typeof vkBridge !== 'undefined') {
      // Получаем параметры запуска
      const params = await vkBridge.send('VKWebAppGetLaunchParams');
      
      // Проверяем, открыто ли приложение через сообщество
      if (params && params.vk_platform && params.vk_platform !== 'desktop_web') {
        // Если открыто через сообщество - закрываем приложение
        await vkBridge.send('VKWebAppClose', { status: 'success' });
      } else {
        // Если открыто вне сообщества - переходим в сообщество
        await vkBridge.send('VKWebAppOpenApp', { 
          app_id: 211148733, // Замените на ID вашего сообщества
          location: 'https://vk.com/ar_mebeli' // Замените на ссылку на ваше сообщество
        });
      }
    } else {
      // Если VK Bridge недоступен, просто переходим в сообщество
      window.open('https://vk.com/ar_mebeli', '_blank');
    }
  } catch (error) {
    console.warn('Ошибка при обработке возврата:', error);
    // Fallback - переходим в сообщество
    window.open('https://vk.com/ar_mebeli', '_blank');
  }
}

render();
</script>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
  vkBridge.send('VKWebAppInit');

  async function forceResize(w = 800, h = 800) {
    try {
      const { vk_platform = '' } = await vkBridge.send('VKWebAppGetLaunchParams');
      if (/android|iphone|ipad|mobile/i.test(vk_platform)) return; // мобильные игнорим

      const doResize = () => vkBridge
        .send('VKWebAppResizeWindow', { width: w, height: h })
        .then(r => console.log('Resize OK', r))
        .catch(e => console.warn('Resize ERR', e));

      doResize();           // сразу
      setTimeout(doResize, 200);  // после прорисовки
      setTimeout(doResize, 600);  // на всякий случай
    } catch (e) {
      console.warn('Bridge init / params failed', e);
    }
  }

  // вызывай на старте
  window.addEventListener('load', () => forceResize(800, 800));

  // и после каждого переключения шага тоже можно:
  // forceResize(800, 800);
</script>

<script>
const COMMUNITY_ID = window.COMMUNITY_ID || 211148733; // TODO: замените 0 на ваш group_id (число)

function showThankYouScreen() {
  const step = document.getElementById('step') || document.body;
  const wrap = document.createElement('div');
  wrap.style.padding = '24px 0';
  wrap.style.textAlign = 'center';

  const h = document.createElement('h2');
  h.textContent = 'Спасибо! Ваша заявка отправлена.';
  h.style.margin = '0 0 8px';
  wrap.appendChild(h);

  const p = document.createElement('div');
  p.textContent = 'Мы свяжемся с вами в ближайшее время. Также можем прислать расчёт в сообщения VK.';
  p.style.color = '#666';
  p.style.marginBottom = '16px';
  wrap.appendChild(p);

  const btns = document.createElement('div');
  btns.style.display = 'flex';
  btns.style.justifyContent = 'center';
  btns.style.gap = '10px';
  btns.style.flexWrap = 'wrap';

  const dmBtn = document.createElement('button');
  dmBtn.className = 'btn primary';
  dmBtn.type = 'button';
  dmBtn.textContent = 'Наши проекты';
  dmBtn.onclick = sendMeInVK;
  btns.appendChild(dmBtn);

  const faqBtn = document.createElement('button');
  faqBtn.className = 'btn primary';
  faqBtn.type = 'button';
  faqBtn.textContent = 'Частые ошибки';
  faqBtn.onclick = sendMeInVK;
  btns.appendChild(faqBtn);

  step.replaceChildren(wrap, btns);
}

function openCommunity() {
  if (!window.vkBridge) { window.open('https://vk.com/public' + COMMUNITY_ID, '_blank'); return; }
  if (!COMMUNITY_ID) { alert('Не задан ID сообщества'); return; }
  vkBridge.send('VKWebAppOpenCommunity', { group_id: COMMUNITY_ID }).catch(async () => {
    await vkBridge.send('VKWebAppOpenURL', { url: 'https://vk.com/public' + COMMUNITY_ID });
  });
}

async function sendMeInVK() {
  try {
    if (!window.vkBridge) throw new Error('VK Bridge недоступен');
    if (!COMMUNITY_ID) throw new Error('Не задан ID сообщества');

    const lp = await vkBridge.send('VKWebAppGetLaunchParams');
    const userId = lp?.vk_user_id;
    if (!userId) throw new Error('Не удалось определить пользователя');

    await vkBridge.send('VKWebAppAllowMessagesFromGroup', {
      group_id: COMMUNITY_ID,
      key: 'quiz_thankyou'
    });

    const r = await fetch('/api/send-welcome', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, group_id: COMMUNITY_ID, answers: (window.state && state.answers) || {} })
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'Сервер ответил ошибкой');

    alert('Мы отправили вам сообщение от сообщества во VK. Проверьте диалоги!');
  } catch (e) {
    console.warn('sendMeInVK error', e);
    alert('Не удалось отправить сообщение. Попробуйте позже.');
  }
}
</script>

</body>
</html>
