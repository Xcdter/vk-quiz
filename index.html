<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–≤–∏–∑: —Ä–∞—Å—á–µ—Ç –∫—É—Ö–Ω–∏</title>
  <!-- VK Bridge (optional inside VK Mini App) -->
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  <script>
    (function(){
      try {
        vkBridge.send('VKWebAppInit');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è VK Mini App
        document.body.classList.add('vk-mini-app');
        
        // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 800x800 –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ —Ä–∞–Ω–Ω—é—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        const ensureResize800 = async () => {
          try{
            const params = await vkBridge.send('VKWebAppGetLaunchParams');
            const platform = (params && params.vk_platform) || '';
            const isDesktop = !/mobile|iphone|ipad|android/i.test(platform);
            if(!isDesktop) return;
            
            const tryResize = async () => {
              try{ await vkBridge.send('VKWebAppResizeWindow', { width: 800, height: 800 }); }catch(e){}
            };
            await tryResize();
            setTimeout(tryResize, 200);
            setTimeout(tryResize, 600);
          }catch(err){
            console.warn('ResizeWindow –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏', err);
          }
        };
        ensureResize800();
      } catch(e) {
        console.warn('VK Bridge –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏');
      }
    })();
  </script>
  <style>
    :root{
      --green:#3db627;
      --green-weak: rgba(61,182,39,.2);
      --text:#111;
      --muted:#666;
      --bg:#fff;
      --card:#fff;
      --accent:#2e8f1d;
      --border:#e8e8e8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,Helvetica Neue,Noto Sans,sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.4;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px;min-width:320px}
    .promo{
      display:flex;gap:12px;align-items:center;
      padding:12px 16px;border-radius:10px;background:#fff;border:1px solid var(--border);
      box-shadow:0 1px 4px rgba(0,0,0,.03);
      font-size:15px;color:#0d2; /* green icon mimic */
    }
    .promo span{color:#111}
    .bar{
      margin:14px 0 24px;border-radius:4px;height:6px;background:var(--green-weak);overflow:hidden;
    }
    .bar>i{display:block;height:100%;width:0;background:var(--green);transition:width .25s ease}
    .card{display:block}
    .title{font-weight:700;font-size:28px;margin:0 0 8px}
    .subtitle{color:var(--muted)}
    .choices{display:grid;grid-template-columns:repeat(3, minmax(180px, 1fr));gap:22px;min-width:0}
    .choice{
      border:2px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card);
      cursor:pointer;transition:transform .1s ease, box-shadow .15s ease, border-color .15s ease;
      display:flex;flex-direction:column;
    }
    .choice:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .choice input{display:none}
    .choice .img{position:relative;aspect-ratio:1/1;background:#f4f4f4;display:block;background-size:cover;background-position:center;width:100%;height:auto}
    .choice .name{padding:10px 12px;font-size:15px;word-wrap:break-word;overflow-wrap:break-word;hyphens:auto;text-align:left;display:block}
    .choice.selected{border-color:var(--green); border-width:2px; box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .choice.selected .img:after{
      content:"";position:absolute;inset:auto 8px 8px auto;width:26px;height:26px;border-radius:50%;
      background:var(--green);box-shadow:0 2px 8px rgba(0,0,0,.2);
      mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23fff" d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>') center/18px no-repeat;
      -webkit-mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23fff" d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>') center/18px no-repeat;
      color:#fff;
    }
    .radios{display:grid;gap:12px}
    .radio{
      display:flex;align-items:center;gap:10px;padding:14px;border-radius:12px;background:#f6f6f6;border:1px solid #eee;cursor:pointer
    }
    .radio input{display:none}
    .radio .dot{
      width:18px;height:18px;border-radius:50%;border:2px solid var(--green);display:inline-block;position:relative;background:#fff;
    }
    .radio.selected{background:#f3f7f3;border-color:#e2f4e2}
    .radio.selected .dot{background:var(--green)}
    .nav{
      display:flex;gap:12px;justify-content:flex-end;margin-top:24px
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:10px;border:1.5px solid var(--green);
      background:#fff;color:var(--green);cursor:pointer;font-weight:600
    }
    .btn.primary{background:var(--green);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .contact-methods{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .pill.selected{border-color:var(--green);background:var(--green-weak)}
    .inputs{display:grid;gap:12px}
    input[type="tel"], input[type="text"]{
      width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--border);font-size:16px
    }
    .left-illu{display:flex;align-items:flex-start;justify-content:center}
    .left-illu .illu{
      width:180px;height:180px;background:#f5faf5;border:1px dashed var(--green);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:42px;color:var(--green)
    }
    @media (max-width:960px){
      .choices{grid-template-columns:repeat(2, minmax(160px,1fr))}
    }

    /* –¢–æ–ª—å–∫–æ –¥–ª—è 2-–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (layout) –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö/–Ω–µ–±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –¥–µ–ª–∞–µ–º 3 –∫–æ–ª–æ–Ω–∫–∏. */
    @media (min-width:720px) and (max-width:960px){
      #step[data-step="layout"] .choices{grid-template-columns:repeat(3, minmax(160px,1fr))}
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è VK Mini App –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ –º–µ–Ω—å—à–µ 800px) */
    @media (max-width: 799px) {
      .vk-mini-app .choices {
        grid-template-columns: repeat(2, minmax(120px, 1fr));
        gap: 12px;
      }
      .vk-mini-app .choice .img {
        aspect-ratio: 1/1;
        width: 100%;
        height: auto;
      }
      .vk-mini-app .choice .name {
        padding: 8px 6px;
        font-size: 13px;
        line-height: 1.2;
        min-height: 2.4em;
        text-align: left;
        display:block;
      }
      .vk-mini-app .title {
        font-size: 22px;
        margin: 0 0 4px;
      }
      .vk-mini-app .wrap {
        padding: 16px;
      }
      .vk-mini-app .promo {
        padding: 8px 12px;
        font-size: 13px;
      }
      .vk-mini-app .bar {
        margin: 10px 0 16px;
      }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ (320px –∏ –±–æ–ª—å—à–µ) */
    @media (min-width: 320px) and (max-width: 479px) {
      .wrap {
        padding: 12px;
        max-width: 100%;
      }
      
      .promo {
        padding: 8px 10px;
        font-size: 12px;
        gap: 8px;
      }
      
      .title {
        font-size: 20px;
        margin: 0 0 6px;
      }
      
      .subtitle {
        font-size: 14px;
      }
      
      .choices {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .choice {
        min-width: 0;
      }
      
      .choice .img {
        aspect-ratio: 1/1;
        width: 100%;
        height: auto;
      }
      
      .choice .name {
        padding: 8px 6px;
        font-size: 13px;
        line-height: 1.2;
        min-height: 2.4em;
        text-align: left;
        display:block;
      }
      
      .radios {
        gap: 8px;
      }
      
      .radio {
        padding: 10px 12px;
        font-size: 14px;
      }
      
      .radio .dot {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }
      
      .contact-methods {
        gap: 6px;
      }
      
      .pill {
        padding: 6px 10px;
        font-size: 13px;
      }
      
      input[type="tel"], input[type="text"] {
        padding: 12px 10px;
        font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
      }
      
      .nav {
        gap: 8px;
        margin-top: 16px;
      }
      
      .btn {
        padding: 10px 14px;
        font-size: 14px;
        gap: 6px;
      }
      
      .bar {
        margin: 8px 0 12px;
        height: 4px;
      }
      
      /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ */
      #step[data-step="thank-you"] {
        padding: 20px 10px;
      }
      
      #step[data-step="thank-you"] .title {
        font-size: 24px;
        margin-bottom: 12px;
      }
      
      #step[data-step="thank-you"] .subtitle {
        font-size: 16px;
        line-height: 1.4;
      }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ (480px - 799px) */
    @media (min-width: 480px) and (max-width: 799px) {
      .wrap {
        padding: 16px;
      }
      
      .promo {
        padding: 10px 12px;
        font-size: 14px;
      }
      
      .title {
        font-size: 24px;
        margin: 0 0 6px;
      }
      
      .choices {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .choice .img {
        aspect-ratio: 1/1;
        width: 100%;
        height: auto;
      }
      
      .choice .name {
        padding: 10px 8px;
        font-size: 14px;
        line-height: 1.3;
        min-height: 2.6em;
        text-align: left;
        display:block;
      }
      
      .radio {
        padding: 12px 14px;
        font-size: 15px;
      }
      
      .pill {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      input[type="tel"], input[type="text"] {
        padding: 14px 12px;
        font-size: 16px;
      }
      
      .btn {
        padding: 12px 16px;
        font-size: 15px;
      }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
    @media (min-width: 800px) {
      .choices {
        grid-template-columns: repeat(4, minmax(140px, 1fr));
        gap: 16px;
        justify-items: center;
      }
      .choice {
        width: 140px;
        max-width: 140px;
      }
      .choice .img {
        aspect-ratio: 1/1;
        width: 100%;
        height: auto;
      }
      .choice .name {
        padding: 10px 8px;
        font-size: 14px;
        line-height: 1.3;
        min-height: 2.6em;
        text-align: left;
        display:block;
      }
      .title {
        font-size: 24px;
        margin: 0 0 6px;
      }
      .wrap {
        padding: 20px;
      }
      .promo {
        padding: 10px 14px;
        font-size: 14px;
      }
      .bar {
        margin: 12px 0 20px;
      }
      
      /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ 1 (style), 2 (layout) –∏ 6 (gift) - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–æ–ª—å—à–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ */
      #step[data-step="style"] .choices {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        justify-items: stretch;
      }
      #step[data-step="layout"] .choices {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        justify-items: stretch;
      }
      #step[data-step="gift"] .choices {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        justify-items: stretch;
      }
      #step[data-step="style"] .choice {
        width: 100%;
        height: 260px;
        max-width: none;
        max-height: 260px;
        display: flex;
        flex-direction: column;
      }
      #step[data-step="layout"] .choice {
        width: 100%;
        height: 220px;
        max-width: none;
        max-height: 220px;
        display: flex;
        flex-direction: column;
      }
      #step[data-step="gift"] .choice {
        width: 100%;
        height: 260px;
        max-width: none;
        max-height: 260px;
        display: flex;
        flex-direction: column;
      }
      #step[data-step="style"] .choice .img {
        height: 200px;
        width: 100%;
        max-height: 200px;
        max-width: 100%;
        flex-shrink: 0;
      }
      #step[data-step="layout"] .choice .img {
        height: 170px;
        width: 100%;
        max-height: 170px;
        max-width: 100%;
        flex-shrink: 0;
      }
      #step[data-step="gift"] .choice .img {
        height: 200px;
        width: 100%;
        max-height: 200px;
        max-width: 100%;
        flex-shrink: 0;
      }
      #step[data-step="style"] .choice .name,
      #step[data-step="layout"] .choice .name,
      #step[data-step="gift"] .choice .name {
        padding: 8px 10px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="promo">üü¢ <span>–£–∑–Ω–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–µ–π –∫—É—Ö–Ω–∏ –∑–∞ 2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫!</span></div>
    <div class="bar" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å"><i id="progress"></i></div>

    <!-- –®–∞–≥–∏ -->
    <section id="step" class="card"></section>

    <div class="nav">
      <button class="btn" id="back"><span>‚Üê</span> –ù–∞–∑–∞–¥</button>
      <button class="btn primary" id="next">–î–∞–ª–µ–µ <span>‚Üí</span></button>
    </div>
  </div>

<script>
// === –î–ê–ù–ù–´–ï –®–ê–ì–û–í (–≤—ã–Ω–µ—Å–µ–Ω—ã, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ª–µ–≥–∫–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) ===
const STEPS = [
  {
    key: 'style',
    title: '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å',
    type: 'tiles',
    tiles: [
      { label: '–§–∞—Å–∞–¥—ã —Å –¥–µ–∫–æ—Ä–æ–º', img: 'https://optim.tildacdn.com/tild3331-3438-4961-a236-363832636336/-/cover/360x360/center/center/-/format/webp/decor_2.png.webp' },
      { label: '–ì–ª–∞–¥–∫–∏–µ —Ñ–∞—Å–∞–¥—ã –±–µ–∑ —Ä—É—á–µ–∫', img: 'https://optim.tildacdn.com/tild3666-6465-4631-b134-366231313766/-/cover/360x360/center/center/-/format/webp/20250729_1852_Minima.png.webp' },
      { label: '–ö—É—Ö–Ω—è –≤ –ø–æ—Ç–æ–ª–æ–∫ —Å –∞–Ω—Ç—Ä–µ—Å–æ–ª—å—é', img: 'https://optim.tildacdn.com/tild3437-6632-4439-b839-626133613536/-/cover/360x360/center/center/-/format/webp/mezz.png.webp' },
      { label: '–ï—â—ë –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏—Å—å', img: 'https://optim.tildacdn.com/tild6539-6630-4337-a238-336530343334/-/cover/360x360/center/center/-/format/webp/dnk.png.webp' },
    ]
  },
  {
    key: 'layout',
    title: '–í—ã–±–µ—Ä–µ—Ç–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É –≤–∞—à–µ–π –±—É–¥—É—â–µ–π –∫—É—Ö–Ω–∏',
    type: 'tiles',
    tiles: [
      { label: '–ü—Ä—è–º–∞—è', img: 'https://optim.tildacdn.com/tild6430-3231-4166-b935-663039366362/-/resize/360x360/-/format/webp/str.png.webp' },
      { label: '–ü-–æ–±—Ä–∞–∑–Ω–∞—è', img: 'https://optim.tildacdn.com/tild3530-3032-4332-a132-366462613937/-/resize/360x360/-/format/webp/a61c8d2d-280d-4280-a.png.webp' },
      { label: '–£–≥–ª–æ–≤–∞—è', img: 'https://optim.tildacdn.com/tild6132-6534-4237-b161-316665333161/-/resize/360x360/-/format/webp/L.jpg.webp' },
      { label: '–° –æ—Å—Ç—Ä–æ–≤–æ–º', img: 'https://optim.tildacdn.com/tild3262-3932-4633-b036-373532653064/-/resize/360x360/-/format/webp/5d06167a-5c45-45c4-b.png.webp' },
      { label: '–î—Ä—É–≥–∞—è', img: 'https://optim.tildacdn.com/tild3432-6539-4564-a633-326531626333/-/resize/360x360/-/format/webp/fd8b5dea-697a-4697-b.jpg.webp' },
      { label: '–ï—â—ë –Ω–µ –∑–Ω–∞—é', img: 'https://optim.tildacdn.com/tild3466-3833-4434-b864-343836656631/-/resize/360x360/-/format/webp/dnk2.png.webp' },
    ]
  },
  {
    key: 'area',
    title: '–£–∫–∞–∂–∏—Ç–µ –ø–ª–æ—â–∞–¥—å –≤–∞—à–µ–π –∫—É—Ö–Ω–∏ –≤ –º–µ—Ç—Ä–∞—Ö¬≤',
    type: 'radios',
    radios: ['–ú–µ–Ω–µ–µ 10 –º–µ—Ç—Ä–æ–≤¬≤','10 - 15 –º–µ—Ç—Ä–æ–≤¬≤','16 - 20 –º–µ—Ç—Ä–æ–≤¬≤','–ë–æ–ª–µ–µ 20 –º–µ—Ç—Ä–æ–≤¬≤','–¢–æ—á–Ω–æ –Ω–µ –ø–æ–º–Ω—é'],
    illu: 'm¬≤'
  },
  {
    key: 'deadline',
    title: '–í –∫–∞–∫–∏–µ —Å—Ä–æ–∫–∏ –≤–∞–º –Ω—É–∂–Ω–∞ –∫—É—Ö–Ω—è?',
    type: 'radios',
    radios: ['–û—Ç 1 –¥–æ 2 –º–µ—Å—è—Ü–µ–≤','–û—Ç 2 –¥–æ 4 –º–µ—Å—è—Ü–µ–≤','–û—Ç 4 –º–µ—Å—è—Ü–µ–≤','–ó–∞—Ç—Ä—É–¥–Ω—è—é—Å—å —Ç–æ—á–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å'],
    illu: '‚è±Ô∏è'
  },
  {
    key: 'budget',
    title: '–í –∫–∞–∫–æ–π –±—é–¥–∂–µ—Ç –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —É–ª–æ–∂–∏—Ç—å—Å—è?',
    type: 'radios',
    radios: ['130 - 200 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π','200 - 300 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π','300 - 400 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π','–ë–æ–ª–µ–µ 400 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π'],
    illu: '‚ÇΩ'
  },
  {
    key: 'gift',
    title: '–í—ã–±–µ—Ä–µ—Ç–µ –ø–æ–¥–∞—Ä–æ–∫ –∫ –≤–∞—à–µ–π –∫—É—Ö–Ω–µ',
    type: 'tiles',
    tiles: [
      { label: '–í—ã—Ç—è–∂–∫–∞', img: 'https://static.tildacdn.com/tild3836-3566-4139-b664-316664376436/photo.png' },
      { label: '–ü–æ–¥—Å–≤–µ—Ç–∫–∞', img: 'https://static.tildacdn.com/tild3330-3932-4430-a232-383734306163/3.png' },
      { label: '–ú–æ–π–∫–∞', img: 'https://static.tildacdn.com/tild6237-6535-4864-b937-633166306132/2.png' },
    ]
  },
  {
    key: 'contact',
    title: '–ì–æ—Ç–æ–≤–æ!',
    subtitle: '–í—ã–±–µ—Ä–µ—Ç–µ, –∫–∞–∫ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫—É—Ö–Ω–∏ –ø–æ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º',
    type: 'contact'
  }
];

const state = { step:0, answers:{} };

const elStep = document.getElementById('step');
const elBack = document.getElementById('back');
const elNext = document.getElementById('next');
const elProgress = document.getElementById('progress');

elBack.addEventListener('click', () => { if(state.step>0){ state.step--; render(); }});
elNext.addEventListener('click', () => { 
  const validation = validate();
  if(!validation.valid) { 
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –æ—à–∏–±–∫–∏:\n\n' + validation.errors.join('\n'));
    return; 
  }
  if(state.step < STEPS.length - 1){ state.step++; render(); }
  else { submit(); }
});

function setProgress(){
  const p = Math.round(((state.step+1)/STEPS.length)*100);
  elProgress.style.width = p + '%';
}

function makeChoiceTile(item, groupKey, selectedValue){
  const div = document.createElement('label');
  div.className = 'choice' + (selectedValue===item.label ? ' selected' : '');
  div.innerHTML = '<input type="radio" name="'+groupKey+'"/>' +
                  '<span class="img" style="background-image:url('+CSS.escape(item.img)+')"></span>' +
                  '<div class="name">'+item.label+'</div>';
  div.addEventListener('click', () => { state.answers[groupKey] = item.label; render(); });
  return div;
}

function makeRadio(label, groupKey, selectedValue){
  const div = document.createElement('label');
  div.className = 'radio' + (selectedValue===label ? ' selected' : '');
  div.innerHTML = '<input type="radio" name="'+groupKey+'"/><i class="dot"></i><span>'+label+'</span>';
  div.addEventListener('click', ()=>{ state.answers[groupKey] = label; render(); });
  return div;
}

function render(){
  setProgress();
  const s = STEPS[state.step];
  elBack.disabled = state.step===0;
  elNext.textContent = state.step === STEPS.length - 1 ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' : '–î–∞–ª–µ–µ ‚Üí';

  // Create main container
  const container = document.createElement('div');
  
  // Add title at the top
  const titleSection = document.createElement('div');
  titleSection.innerHTML = '<h1 class="title">'+s.title+'</h1>' + (s.subtitle ? '<div class="subtitle">'+s.subtitle+'</div>' : '');
  container.appendChild(titleSection);

  // Add content below title
  const contentSection = document.createElement('div');
  contentSection.style.marginTop = '24px';
  
  if(s.type==='tiles'){
    const grid = document.createElement('div'); grid.className='choices';
    (s.tiles||[]).forEach(t => grid.appendChild(makeChoiceTile(t, s.key, state.answers[s.key])));
    contentSection.appendChild(grid);
  }else if(s.type==='radios'){
    const list = document.createElement('div'); list.className='radios';
    s.radios.forEach(r => list.appendChild(makeRadio(r, s.key, state.answers[s.key])));
    contentSection.appendChild(list);
  }else if(s.type==='contact'){
    const methods = document.createElement('div'); methods.className='contact-methods';
    methods.style.marginBottom = '20px';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –º–µ—Ç–æ–¥–æ–≤ —Å–≤—è–∑–∏
    const methodsTitle = document.createElement('div');
    methodsTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ *';
    methodsTitle.style.fontSize = '16px';
    methodsTitle.style.fontWeight = '600';
    methodsTitle.style.marginBottom = '12px';
    methodsTitle.style.color = 'var(--text)';
    methods.appendChild(methodsTitle);
    
    const methodsContainer = document.createElement('div');
    methodsContainer.style.display = 'flex';
    methodsContainer.style.gap = '8px';
    methodsContainer.style.flexWrap = 'wrap';
    
    ['–¢–µ–ª–µ—Ñ–æ–Ω','Telegram','WhatsApp'].forEach(m=>{
      const pill=document.createElement('button'); 
      pill.type='button'; 
      pill.className='pill'+(state.answers['method']===m?' selected':''); 
      pill.textContent=m;
      pill.addEventListener('click',()=>{ state.answers.method=m; render(); });
      methodsContainer.appendChild(pill);
    });
    methods.appendChild(methodsContainer);
    
    const inputs = document.createElement('div'); 
    inputs.className='inputs';
    inputs.style.display = 'grid';
    inputs.style.gap = '16px';
    
    // –ü–æ–ª–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneContainer = document.createElement('div');
    const phoneLabel = document.createElement('div');
    phoneLabel.textContent = '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *';
    phoneLabel.style.fontSize = '16px';
    phoneLabel.style.fontWeight = '600';
    phoneLabel.style.marginBottom = '8px';
    phoneLabel.style.color = 'var(--text)';
    
    const phone = document.createElement('input'); 
    phone.type='tel'; 
    phone.placeholder='+7 (999) 999-99-99'; 
    phone.value = state.answers.phone || '';
    phone.style.width = '100%';
    phone.style.padding = '14px 12px';
    phone.style.borderRadius = '12px';
    phone.style.border = '1px solid var(--border)';
    phone.style.fontSize = '16px';
    phone.style.boxSizing = 'border-box';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    phone.addEventListener('input', function(e) {
      let value = e.target.value;
      
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä, +, (, ), -, –ø—Ä–æ–±–µ–ª–æ–≤
      value = value.replace(/[^\d\s\(\)\+\-]/g, '');
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
      if (value.length > 25) {
        value = value.substring(0, 25);
      }
      
      e.target.value = value;
      state.answers.phone = value;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º normalizePhone
      validatePhoneField(phone);
    });
    
    phone.addEventListener('blur', function() {
      validatePhoneField(phone);
    });
    
    phoneContainer.appendChild(phoneLabel);
    phoneContainer.appendChild(phone);
    
    // –ü–æ–ª–µ –¥–ª—è –∏–º–µ–Ω–∏
    const nameContainer = document.createElement('div');
    const nameLabel = document.createElement('div');
    nameLabel.textContent = '–í–∞—à–µ –∏–º—è *';
    nameLabel.style.fontSize = '16px';
    nameLabel.style.fontWeight = '600';
    nameLabel.style.marginBottom = '8px';
    nameLabel.style.color = 'var(--text)';
    
    const name = document.createElement('input'); 
    name.type='text'; 
    name.placeholder='–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è'; 
    name.value = state.answers.name || '';
    name.style.width = '100%';
    name.style.padding = '14px 12px';
    name.style.borderRadius = '12px';
    name.style.border = '1px solid var(--border)';
    name.style.fontSize = '16px';
    name.style.boxSizing = 'border-box';
    
    name.addEventListener('input', e=> state.answers.name = e.target.value);
    
    nameContainer.appendChild(nameLabel);
    nameContainer.appendChild(name);
    
    contentSection.appendChild(methods);
    contentSection.appendChild(phoneContainer);
    contentSection.appendChild(nameContainer);
  }

  container.appendChild(contentSection);

  // –ü–æ–º–µ—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥ –∞—Ç—Ä–∏–±—É—Ç–æ–º –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
  elStep.setAttribute('data-step', s.key);
  elStep.replaceChildren(container);
  if(s.type==='tiles'){
    fitTileLabelsToOneLine(elStep);
  }
}

// –ü–æ–¥–≥–æ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –ø–æ–¥–ø–∏—Å–µ–π –≤ –ø–ª–∏—Ç–∫–∞—Ö —Ç–∞–∫, —á—Ç–æ–±—ã –≤—Å–µ –ø–æ–º–µ—â–∞–ª–∏—Å—å –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
function fitTileLabelsToOneLine(scope){
  const nameNodes = Array.from(scope.querySelectorAll('.choice .name'));
  if(nameNodes.length===0) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞
  const isSmallScreen = window.innerWidth <= 479;
  
  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–Ω–ª–∞–π–Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
  nameNodes.forEach(n => { 
    n.style.fontSize=''; 
    // –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫
    n.style.whiteSpace = isSmallScreen ? 'normal' : 'nowrap';
    n.style.wordWrap = isSmallScreen ? 'break-word' : 'normal';
    n.style.overflowWrap = isSmallScreen ? 'break-word' : 'normal';
  });
  
  // –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –Ω–µ –∏–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞, –ø–æ–∑–≤–æ–ª—è–µ–º —Ç–µ–∫—Å—Ç—É –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è
  if(isSmallScreen) return;
  
  const computed = parseFloat(getComputedStyle(nameNodes[0]).fontSize) || 14;
  const minPx = 12;
  const maxPx = Math.max(18, computed); // –ø–æ–∑–≤–æ–ª—è–µ–º —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 18px –º–∏–Ω–∏–º—É–º

  const overflows = () => nameNodes.some(el => el.scrollWidth > el.clientWidth);

  // –±–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –≤–ª–µ–∑–∞–µ—Ç —É –≤—Å–µ—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  let lo = minPx, hi = maxPx, best = minPx;
  while(lo <= hi){
    const mid = Math.floor((lo + hi) / 2);
    nameNodes.forEach(n => n.style.fontSize = mid + 'px');
    if(!overflows()){
      best = mid;
      lo = mid + 1;
    }else{
      hi = mid - 1;
    }
  }
  nameNodes.forEach(n => n.style.fontSize = best + 'px');
}

// –£–±—Ä–∞–ª–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π —Ä–∞–∑–º–µ—Ä–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ CSS –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤

function validate(){
  const s = STEPS[state.step];
  if(s.type==='tiles' || s.type==='radios'){
    if (!state.answers[s.key]) {
      return { valid: false, errors: ['–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç'] };
    }
    return { valid: true };
  }
  if(s.type==='contact'){
    const errors = [];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏
    if (!state.answers.method) {
      errors.push('‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ –∏–º—è
    if (!state.answers.name || state.answers.name.trim().length < 2) {
      errors.push('‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º normalizePhone
    const phoneValue = state.answers.phone || '';
    const phoneResult = normalizePhone(phoneValue);
    
    if (!phoneValue.trim()) {
      errors.push('‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
    } else if (!phoneResult.valid) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
      switch (phoneResult.reason) {
        case 'empty':
          errors.push('‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
          break;
        case 'all_same_digits':
          errors.push('‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ü–∏—Ñ—Ä');
          break;
        case 'all_zeros':
          errors.push('‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –Ω—É–ª–µ–π');
          break;
        case 'length':
          errors.push('‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 10 –¥–æ 15 —Ü–∏—Ñ—Ä');
          break;
        case 'leading_zero':
          errors.push('‚Ä¢ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –Ω—É–ª—è');
          break;
        case 'e164':
          errors.push('‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ');
          break;
        default:
          errors.push('‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
      }
    }
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    if (errors.length > 0) {
      return { valid: false, errors: errors };
    }
    
    return { valid: true };
  }
  return { valid: true };
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ E.164 (+XXXXXXXXXX...)
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { valid, e164, reason }
function normalizePhone(raw) {
  if (!raw) return { valid: false, e164: "", reason: "empty" };

  // 1) —É–±—Ä–∞—Ç—å –≤—Å—ë, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ '+' (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π '+')
  let v = String(raw).trim();
  const plus = v.startsWith("+");
  v = (plus ? "+" : "") + v.replace(/[^\d]/g, "");

  // 2) –µ—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å '00', –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ '+'
  if (v.startsWith("00")) v = "+" + v.slice(2);

  // 3) Russian special-case: 8XXXXXXXXXX (11 —Ü–∏—Ñ—Ä) ‚Üí +7XXXXXXXXXX
  let digits = v.replace(/\D/g, "");
  if (!plus && digits.length === 11 && digits[0] === "8") {
    digits = "7" + digits.slice(1);
    v = "+" + digits;
  }

  // 4) –ë–∞–∑–æ–≤–∞—è E.164: +, –∑–∞—Ç–µ–º 10‚Äì15 —Ü–∏—Ñ—Ä, –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ –æ—Ç 1 –¥–æ 9
  // –ü—Ä–æ–ø—É—Å—Ç–∏–º –∏ –≤–∞—Ä–∏–∞–Ω—Ç –±–µ–∑ '+' (–Ω–∞–ø—Ä–∏–º–µ—Ä, "7999..."), –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –≤ '+...'
  if (!v.startsWith("+")) v = "+" + digits;
  digits = v.replace(/\D/g, "");

  // –¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∑–∞–≤–µ–¥–æ–º–æ –º—É—Å–æ—Ä: –≤—Å–µ —Ü–∏—Ñ—Ä—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ / –≤—Å–µ –Ω—É–ª–∏
  const allSame = /^(\d)\1+$/.test(digits);
  if (allSame) return { valid: false, e164: "", reason: "all_same_digits" };
  if (/^0+$/.test(digits)) return { valid: false, e164: "", reason: "all_zeros" };

  // –¥–ª–∏–Ω–∞ –∏ –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞
  if (digits.length < 10 || digits.length > 15) {
    return { valid: false, e164: "", reason: "length" };
  }
  if (digits[0] === "0") {
    return { valid: false, e164: "", reason: "leading_zero" };
  }

  // —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —à–∞–±–ª–æ–Ω–∞ E.164
  const e164 = "+" + digits;
  if (!/^\+[1-9]\d{9,14}$/.test(e164)) {
    return { valid: false, e164: "", reason: "e164" };
  }
  return { valid: true, e164 };
}

// –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º normalizePhone
function validatePhoneField(phoneInput) {
  const value = phoneInput.value;
  const result = normalizePhone(value);
  
  // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
  if (value && !result.valid) {
    phoneInput.style.borderColor = '#ff4444';
    phoneInput.style.backgroundColor = '#fff5f5';
  } else if (value && result.valid) {
    phoneInput.style.borderColor = 'var(--green)';
    phoneInput.style.backgroundColor = '#f8fff8';
  } else {
    phoneInput.style.borderColor = 'var(--border)';
    phoneInput.style.backgroundColor = '#fff';
  }
  
  return result.valid;
}

function submit(){
  // –ü–æ–∫–∞–∑–∞—Ç—å –∏—Ç–æ–≥/–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—É–¥–∞ –Ω—É–∂–Ω–æ. –ó–¥–µ—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ alert + –ª–æ–≥.
  const payload = JSON.stringify(state.answers, null, 2);
  console.log('–û—Ç–≤–µ—Ç—ã –∫–≤–∏–∑–∞:', state.answers);
  
  // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
  document.querySelector('.nav').style.display = 'none';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
  showThankYouScreen();
  
  // –ü—Ä–∏–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä/–±–æ—Ç–∞:
  // fetch('/lead', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(state.answers) })
  //   .then(()=>showThankYouScreen()).catch(()=>alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'));
}

function showThankYouScreen(){
  const container = document.createElement('div');
  container.style.textAlign = 'center';
  container.style.padding = '40px 20px';
  
  // –ò–∫–æ–Ω–∫–∞ –≥–∞–ª–æ—á–∫–∏
  const checkIcon = document.createElement('div');
  checkIcon.style.width = '80px';
  checkIcon.style.height = '80px';
  checkIcon.style.borderRadius = '50%';
  checkIcon.style.background = 'var(--green)';
  checkIcon.style.margin = '0 auto 24px';
  checkIcon.style.display = 'flex';
  checkIcon.style.alignItems = 'center';
  checkIcon.style.justifyContent = 'center';
  checkIcon.style.fontSize = '40px';
  checkIcon.style.color = '#fff';
  checkIcon.innerHTML = '‚úì';
  
  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  const title = document.createElement('h1');
  title.className = 'title';
  title.textContent = '–°–ø–∞—Å–∏–±–æ!';
  title.style.marginBottom = '16px';
  
  // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
  const subtitle = document.createElement('div');
  subtitle.className = 'subtitle';
  subtitle.textContent = '–ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à—É –∑–∞—è–≤–∫—É –∏ —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.';
  subtitle.style.fontSize = '18px';
  subtitle.style.lineHeight = '1.5';
  subtitle.style.color = 'var(--muted)';
  subtitle.style.marginBottom = '32px';
  
  // –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
  const returnButton = document.createElement('button');
  returnButton.className = 'btn primary';
  returnButton.textContent = '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ';
  returnButton.style.marginTop = '24px';
  returnButton.addEventListener('click', handleReturn);
  
  container.appendChild(checkIcon);
  container.appendChild(title);
  container.appendChild(subtitle);
  container.appendChild(returnButton);
  
  // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —ç–∫—Ä–∞–Ω –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
  elStep.setAttribute('data-step', 'thank-you');
  elStep.replaceChildren(container);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –Ω–∞ 100%
  elProgress.style.width = '100%';
}

// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º
async function handleReturn() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ VK Bridge
    if (typeof vkBridge !== 'undefined') {
      // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞
      const params = await vkBridge.send('VKWebAppGetLaunchParams');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
      if (params && params.vk_platform && params.vk_platform !== 'desktop_web') {
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ - –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        await vkBridge.send('VKWebAppClose', { status: 'success' });
      } else {
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
        await vkBridge.send('VKWebAppOpenApp', { 
          app_id: 211148733, // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ ID –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
          location: 'https://vk.com/ar_mebeli' // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
        });
      }
    } else {
      // –ï—Å–ª–∏ VK Bridge –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
      window.open('https://vk.com/ar_mebeli', '_blank');
    }
  } catch (error) {
    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–∑–≤—Ä–∞—Ç–∞:', error);
    // Fallback - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
    window.open('https://vk.com/ar_mebeli', '_blank');
  }
}

render();
</script>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
  vkBridge.send('VKWebAppInit');

  async function forceResize(w = 800, h = 800) {
    try {
      const { vk_platform = '' } = await vkBridge.send('VKWebAppGetLaunchParams');
      if (/android|iphone|ipad|mobile/i.test(vk_platform)) return; // –º–æ–±–∏–ª—å–Ω—ã–µ –∏–≥–Ω–æ—Ä–∏–º

      const doResize = () => vkBridge
        .send('VKWebAppResizeWindow', { width: w, height: h })
        .then(r => console.log('Resize OK', r))
        .catch(e => console.warn('Resize ERR', e));

      doResize();           // —Å—Ä–∞–∑—É
      setTimeout(doResize, 200);  // –ø–æ—Å–ª–µ –ø—Ä–æ—Ä–∏—Å–æ–≤–∫–∏
      setTimeout(doResize, 600);  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    } catch (e) {
      console.warn('Bridge init / params failed', e);
    }
  }

  // –≤—ã–∑—ã–≤–∞–π –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
  window.addEventListener('load', () => forceResize(800, 800));

  // –∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —à–∞–≥–∞ —Ç–æ–∂–µ –º–æ–∂–Ω–æ:
  // forceResize(800, 800);
</script>

<script>
const COMMUNITY_ID = window.COMMUNITY_ID || 211148733; // TODO: –∑–∞–º–µ–Ω–∏—Ç–µ 0 –Ω–∞ –≤–∞—à group_id (—á–∏—Å–ª–æ)

function showThankYouScreen() {
  const step = document.getElementById('step') || document.body;
  const wrap = document.createElement('div');
  wrap.style.padding = '24px 0';
  wrap.style.textAlign = 'center';

  const h = document.createElement('h2');
  h.textContent = '–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.';
  h.style.margin = '0 0 8px';
  wrap.appendChild(h);

  const p = document.createElement('div');
  p.textContent = '–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. –¢–∞–∫–∂–µ –º–æ–∂–µ–º –ø—Ä–∏—Å–ª–∞—Ç—å —Ä–∞—Å—á—ë—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏—è VK.';
  p.style.color = '#666';
  p.style.marginBottom = '16px';
  wrap.appendChild(p);

  const btns = document.createElement('div');
  btns.style.display = 'flex';
  btns.style.justifyContent = 'center';
  btns.style.gap = '10px';
  btns.style.flexWrap = 'wrap';

  const dmBtn = document.createElement('button');
  dmBtn.className = 'btn primary';
  dmBtn.type = 'button';
  dmBtn.textContent = '–ù–∞—à–∏ –ø—Ä–æ–µ–∫—Ç—ã';
  dmBtn.onclick = sendMeInVK;
  btns.appendChild(dmBtn);

  const faqBtn = document.createElement('button');
  faqBtn.className = 'btn primary';
  faqBtn.type = 'button';
  faqBtn.textContent = '–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏';
  faqBtn.onclick = sendMeInVK;
  btns.appendChild(faqBtn);

  step.replaceChildren(wrap, btns);
}

function openCommunity() {
  if (!window.vkBridge) { window.open('https://vk.com/public' + COMMUNITY_ID, '_blank'); return; }
  if (!COMMUNITY_ID) { alert('–ù–µ –∑–∞–¥–∞–Ω ID —Å–æ–æ–±—â–µ—Å—Ç–≤–∞'); return; }
  vkBridge.send('VKWebAppOpenCommunity', { group_id: COMMUNITY_ID }).catch(async () => {
    await vkBridge.send('VKWebAppOpenURL', { url: 'https://vk.com/public' + COMMUNITY_ID });
  });
}

async function sendMeInVK() {
  try {
    if (!window.vkBridge) throw new Error('VK Bridge –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
    if (!COMMUNITY_ID) throw new Error('–ù–µ –∑–∞–¥–∞–Ω ID —Å–æ–æ–±—â–µ—Å—Ç–≤–∞');

    const lp = await vkBridge.send('VKWebAppGetLaunchParams');
    const userId = lp?.vk_user_id;
    if (!userId) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

    await vkBridge.send('VKWebAppAllowMessagesFromGroup', {
      group_id: COMMUNITY_ID,
      key: 'quiz_thankyou'
    });

    const r = await fetch('/api/send-welcome', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, group_id: COMMUNITY_ID, answers: (window.state && state.answers) || {} })
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || '–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª –æ—à–∏–±–∫–æ–π');

    alert('–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –≤–æ VK. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏–∞–ª–æ–≥–∏!');
  } catch (e) {
    console.warn('sendMeInVK error', e);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}
</script>

</body>
</html>
